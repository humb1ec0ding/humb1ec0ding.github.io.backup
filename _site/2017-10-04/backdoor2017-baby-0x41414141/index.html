<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>[CTF] backdoor 2017 baby-0x41414141</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css">

  <!-- Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Writeup oriented CTF for fun and profit" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>[CTF] backdoor 2017 baby-0x41414141 | Writeup oriented CTF for fun and profit</title>
<meta property="og:title" content="[CTF] backdoor 2017 baby-0x41414141" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A. Write-up" />
<meta property="og:description" content="A. Write-up" />
<link rel="canonical" href="http://localhost:4000/2017-10-04/backdoor2017-baby-0x41414141/" />
<meta property="og:url" content="http://localhost:4000/2017-10-04/backdoor2017-baby-0x41414141/" />
<meta property="og:site_name" content="Writeup oriented CTF for fun and profit" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-10-04T13:00:00+09:00" />
<script type="application/ld+json">
{"name":null,"description":"A. Write-up","author":null,"@type":"BlogPosting","url":"http://localhost:4000/2017-10-04/backdoor2017-baby-0x41414141/","publisher":null,"image":null,"headline":"[CTF] backdoor 2017 baby-0x41414141","dateModified":"2017-10-04T13:00:00+09:00","datePublished":"2017-10-04T13:00:00+09:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017-10-04/backdoor2017-baby-0x41414141/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->



  <!-- Google Analytics -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>



</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000">Writeup oriented CTF for fun and profit</a>
  </div>
</header>
<div class="post">
  <div class="post-title">[CTF] backdoor 2017 baby-0x41414141</div>
  <span class="post-date">
    <time>04 Oct 2017</time>
  </span>
  <div class="post-tag">
    <ul>
      
      <li>
        <a href="http://localhost:4000/tags#fsb">
          <span>fsb</span>
        </a>
      </li>
      
      
    </ul>
  </div>

  <h2 id="a-write-up">A. Write-up</h2>

<p><a href="https://ctftime.org/task/4682">CTFtime.org / BackdoorCTF 2017 / baby-0x41414141</a></p>

<ul>
  <li><a href="https://github.com/ShellCollectingClub/backdoor2017/tree/master/Baby_0x41414141">backdoor2017/Baby_0x41414141 at master · ShellCollectingClub/backdoor2017</a></li>
</ul>

<h2 id="b-basic-info">B. Basic info</h2>

<h3 id="1-code">1. Code</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-200h]
</span>  <span class="kt">char</span> <span class="n">format</span><span class="p">;</span> <span class="c1">// [esp+E0h] [ebp-138h]
</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+20Ch] [ebp-Ch]
</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Hello baby pwner, whats your name?"</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">edata</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">edata</span><span class="p">);</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="s">"Ok cool, soon we will know whether you pwned it or not. Till then Bye %s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>  <span class="c1">// FSB
</span>  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="2-protection">2. Protection</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef)  checksec
[+] checksec for '/media/psf/Home/_2O2L2H/github/awesome-ctf-wargame/ctf/2017/backdoor/baby_0x41414141/32_new'
Canary                        : No
NX                            : Yes
PIE                           : No
Fortify                       : No
RelRO                         : Partial
</code></pre></div></div>

<h3 id="3-initial-execution">3. Initial execution</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./32_new
Hello baby pwner, whats your name?
AAAA,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p
Ok cool, soon we will know whether you pwned it or not. Till <span class="k">then </span>Bye AAAA,0x8048914,0xffb2da08,0x1,0xf744d618,0x36e,0xf7453668,0xffb2dcb4,0xffb2da54,0xffb2da50,0x41414141,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025,0x70252c70,0x2c70252c,0x252c7025
</code></pre></div></div>

<h2 id="c-how-to-exploit">C. How to exploit</h2>

<p>Flag 찍어주는 함수가 있으므로  이 함수로 <code class="highlighter-rouge">eip</code> setting 하면 될 듯….</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">system</span><span class="p">(</span><span class="s">"cat flag.txt"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>FSB write를 이용하여 <code class="highlighter-rouge">exit()</code> GOT 를 <code class="highlighter-rouge">flag()</code> overwrite 하면 될 듯.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="s">"Ok cool, soon we will know whether you pwned it or not. Till then Bye %s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>  <span class="c1">// FSB
</span>  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="d-exploit--fsb-basic-attack">D. Exploit : FSB basic attack</h2>

<p><a href="https://teamrocketist.github.io/2017/09/25/Pwn-BackdoorCTF-2017-baby0x41414141/">BackdoorCTF 2017 - baby0x41414141 : TeamRocketIST - Portuguese CTF Team</a></p>

<p><code class="highlighter-rouge">exit()</code> GOT 값을 <code class="highlighter-rouge">flag()</code> 함수 값으로 변경하여 프로그램 종료 시 <code class="highlighter-rouge">exit()</code> 시에 <code class="highlighter-rouge">flag()</code> 함수 호출되도록 exploit 하기.</p>

<h4 id="exit"><code class="highlighter-rouge">exit()</code></h4>

<p>PLT 는 <code class="highlighter-rouge">0x80485f0</code>, GOT는 <code class="highlighter-rouge">0x804a034</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ x/10i 0x080485F0
   0x80485f0 &lt;exit@plt&gt;:        jmp    DWORD PTR ds:0x804a034
   0x80485f6 &lt;exit@plt+6&gt;:      push   0x50
   0x80485fb &lt;exit@plt+11&gt;:     jmp    0x8048540
   0x8048600:   jmp    DWORD PTR ds:0x8049ffc

gdb-peda$ x/10i 0x804A034
   0x804a034:   test   BYTE PTR [ebp+0x804],0x0
   0x804a03b:   add    BYTE PTR [eax],al
   0x804a03d:   add    BYTE PTR [eax],al
   0x804a03f:   add    BYTE PTR [eax+0x60f7e305],ah
</code></pre></div></div>

<h4 id="flag-함수"><code class="highlighter-rouge">flag()</code> 함수</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">10</span><span class="n">i</span> <span class="mh">0x0804870B</span>
   <span class="mh">0x804870b</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">&gt;:</span>        <span class="n">push</span>   <span class="n">ebp</span>
   <span class="mh">0x804870c</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>      <span class="n">mov</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
   <span class="mh">0x804870e</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>      <span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x8048711</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>      <span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0xc</span>
   <span class="mh">0x8048714</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>      <span class="n">push</span>   <span class="mh">0x80488e0</span>
   <span class="mh">0x8048719</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>     <span class="n">call</span>   <span class="mh">0x8048570</span> <span class="o">&lt;</span><span class="n">system</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x804871e</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">19</span><span class="o">&gt;:</span>     <span class="n">add</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x10</span>
   <span class="mh">0x8048721</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span>     <span class="n">nop</span>
   <span class="mh">0x8048722</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>     <span class="n">leave</span>
   <span class="mh">0x8048723</span> <span class="o">&lt;</span><span class="n">_Z4flagv</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span>     <span class="n">ret</span>
</code></pre></div></div>

<h2 id="e-exploit--libformatstr-사용">E. Exploit : <code class="highlighter-rouge">libformatstr</code> 사용</h2>

<p><a href="https://github.com/hellman/libformatstr">hellman/libformatstr: Simplify format string exploitation.</a></p>



  <!-- Disqus -->
  
  <div class="post-disqus">
      <section id="disqus_thread"></section>
      <script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//humb1ec0ding.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  </div>
  

</div>


    <!-- Documents about icons are here: http://fontawesome.io/icons/ -->
<div class="footer">
  <hr />
  <div class="footer-link">
    
	
	
	
	

    
    <a href="https://twitter.com/humb1ec0ding"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    

    
    <a href="https://github.com/humb1ec0ding"><i class="fa fa-github" aria-hidden="true"></i></a>
    
	
	
	
	

    
	
	
	
	
	
	
	
	

    

    

    
    <a href="mailto:humblecoding@gmail.com"><i class="fa fa-envelope" aria-hidden="true"></i></a>
    

  </div>
  © 2017 humb1ec0ding. All rights reserved.
</div>

  </div>
</body>
</html>
